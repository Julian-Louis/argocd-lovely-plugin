apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    app: rbac-manager
    chart: rbac-manager-1.7.0
    heritage: Helm
    release: test
  name: rbacdefinitions.rbacmanager.reactiveops.io
spec:
  group: rbacmanager.reactiveops.io
  names:
    kind: RBACDefinition
    plural: rbacdefinitions
    shortNames:
    - rbd
    - rbacdef
    singular: rbacdefinition
  scope: Cluster
  versions:
  - name: v1beta1
    schema:
      openAPIV3Schema:
        properties:
          rbacBindings:
            items:
              properties:
                clusterRoleBindings:
                  items:
                    properties:
                      clusterRole:
                        type: string
                    required:
                    - clusterRole
                    type: object
                  type: array
                name:
                  type: string
                roleBindings:
                  items:
                    properties:
                      clusterRole:
                        type: string
                      namespace:
                        type: string
                      namespaceSelector:
                        properties:
                          matchExpressions:
                            items:
                              properties:
                                key:
                                  type: string
                                operator:
                                  enum:
                                  - Exists
                                  - DoesNotExist
                                  - In
                                  - NotIn
                                  type: string
                                values:
                                  items:
                                    type: string
                                  type: array
                              required:
                              - key
                              - operator
                              type: object
                            type: array
                          matchLabels:
                            additionalProperties:
                              type: string
                            type: object
                        type: object
                      role:
                        type: string
                    type: object
                  type: array
                subjects:
                  items:
                    properties:
                      imagePullSecrets:
                        items:
                          type: string
                        type: array
                      kind:
                        enum:
                        - Group
                        - ServiceAccount
                        - User
                        type: string
                      name:
                        type: string
                      namespace:
                        type: string
                    required:
                    - name
                    - kind
                    type: object
                  type: array
              required:
              - name
              - subjects
              type: object
            type: array
          status:
            type: object
        required:
        - rbacBindings
        type: object
    served: true
    storage: true
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: rbac-manager
    chart: rbac-manager-1.7.0
    heritage: Helm
    release: test
  name: test-rbac-manager
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app: rbac-manager
    chart: rbac-manager-1.7.0
    heritage: Helm
    release: test
  name: test-rbac-manager
rules:
- apiGroups:
  - rbacmanager.reactiveops.io
  resources:
  - rbacdefinitions
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - rbac.authorization.k8s.io
  - authorization.k8s.io
  resources:
  - '*'
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - serviceaccounts
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app: rbac-manager
    chart: rbac-manager-1.7.0
    heritage: Helm
    release: test
  name: test-rbac-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: test-rbac-manager
subjects:
- kind: ServiceAccount
  name: test-rbac-manager
  namespace: testnamespace
---
apiVersion: v1
data:
  squid.conf: |
    cache_log stdio:/dev/stdout
    access_log stdio:/dev/stdout
    cache_store_log stdio:/dev/stdout

    auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/squid_passwd
    acl all src all
    acl ncsa_users proxy_auth REQUIRED
    acl SSL_ports port 443          # SSL
    acl Safe_ports port 80          # http
    acl Safe_ports port 21          # ftp
    acl Safe_ports port 443         # https
    acl Safe_ports port 70          # gopher
    acl Safe_ports port 210         # wais
    acl Safe_ports port 1025-65535  # unregistered ports
    acl Safe_ports port 280         # http-mgmt
    acl Safe_ports port 488         # gss-http
    acl Safe_ports port 591         # filemaker
    acl Safe_ports port 777         # multiling http
    acl Safe_ports port 5190        # ICQ
    acl CONNECT method CONNECT

    http_access allow ncsa_users
    http_access allow !Safe_ports
    http_access allow !SSL_ports
    http_access deny all
    http_port 3128
    dns_v4_first on
kind: ConfigMap
metadata:
  name: squid.conf-gd4648db9b
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: rbac-manager
    chart: rbac-manager-1.7.0
    heritage: Helm
    release: test
  name: test-rbac-manager
spec:
  replicas: 5
  selector:
    matchLabels:
      app: rbac-manager
      release: test
  template:
    metadata:
      labels:
        app: rbac-manager
        release: test
    spec:
      containers:
      - image: quay.io/reactiveops/rbac-manager:v0.10.0
        imagePullPolicy: Always
        livenessProbe:
          httpGet:
            path: /metrics
            port: 8042
            scheme: HTTP
        name: rbac-manager
        ports:
        - containerPort: 8042
          name: http-metrics
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /metrics
            port: 8042
            scheme: HTTP
          initialDelaySeconds: 5
          periodSeconds: 3
          timeoutSeconds: 3
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 128Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          privileged: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
      serviceAccountName: test-rbac-manager
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-production
    nginx.ingress.kubernetes.io/auth-signin: https://$host/oauth2/start?rd=$escaped_request_uri
    nginx.ingress.kubernetes.io/auth-url: https://$host/oauth2/auth
  name: testoauth
spec:
  ingressClassName: nginx
  rules:
  - host: testoauth.wpscloud.co.uk
    http:
      paths:
      - backend:
          serviceName: testoauth
          servicePort: http
        path: /
  tls:
  - hosts:
    - testoauth.wpscloud.co.uk
    secretName: testoauth-tls-secret
